eng.validators["email"]={type:"regexp",expression:"^([a-zA-Z0-9_.\\-+])+@(([a-zA-Z0-9\\-])+\\.)+[a-zA-Z0-9]{2,4}$",errorMessage:"No es un correo electr\u00f3nico v\u00e1lido"};eng.validators["zipcode"]={type:"regexp",expression:"^\\d{5}(-\\d{4})?$",errorMessage:"El codigo postal debe tener el formato ##### o #####-####."};
eng.fieldProcesors["text"]=function(field){var base=eng.utils.cloneObject(field);if(!base.startRow)base.startRow=true;if(!base.width)base.width="100%";if(!base.type)base.type="TextAreaItem";return base};
eng.fieldProcesors["select"]=function(field){var base=eng.utils.cloneObject(field);var dsObjDef=eng.getDataSourceObjDef(eng.utils.removeAttribute(base,"dataSource"));var dsf;var dsfmt;if(dsObjDef.dsName){var ds=eng.createDataSource(dsObjDef,true,base);dsObjDef.ds=ds;if(ds==null)console.log("Undefined DS:",dsObjDef,field);else{dsf=ds.displayField;dsfmt=ds.displayFormat;ds.canQueueRequests=false}}if(!base.allowFilterOperators)base.allowFilterOperators=false;if(!base.editorType)if(dsfmt||base.multiple===
true)base.editorType="SelectItem";else if(base.canFilter!=undefined){if(base.canFilter===true)base.editorType="ComboBoxItem";else base.editorType="SelectItem";eng.utils.removeAttribute(base,"canFilter")}else base.editorType="ComboBoxItem";if(base.displayFormat)dsfmt=base.displayFormat;else if(!base.displayField)base.displayField=dsf;if(!base.valueField)base.valueField="_id";eng.utils.removeAttribute(base,"displayFormat");if(dsfmt)base.formatValue=function(value,baserecord,form,item){var record=item.getSelectedRecord();
if(record)if("function"==typeof dsfmt)return dsfmt(value,record);else return eval(dsfmt);else return value};base.optionDataSource=dsObjDef.dsId;if(!base.editorProperties)base.editorProperties={};if(!base.editorProperties.addUnknownValues)base.editorProperties.addUnknownValues=false;if(!base.editorProperties.sortField)if(base.editorProperties.sortField===null)delete base.editorProperties.sortField;else base.editorProperties.sortField=dsf;if(base.textMatchStyle)base.editorProperties.textMatchStyle=
base.textMatchStyle;else if(!base.editorProperties.textMatchStyle)base.editorProperties.textMatchStyle="exact";if(base.getFilterCriteria)base.editorProperties.getPickListFilterCriteria=eng.utils.removeAttribute(base,"getFilterCriteria");if(base.showFilter)base.pickListProperties={showFilterEditor:eng.utils.removeAttribute(base,"showFilter")};if(base.selectFields)base.pickListFields=eng.utils.removeAttribute(base,"selectFields");if(base.selectWidth)base.pickListWidth=eng.utils.removeAttribute(base,
"selectWidth");if(base.initialCriteria)base.optionCriteria=eng.utils.removeAttribute(base,"initialCriteria");return base};
eng.fieldProcesors["oldSelect"]=function(field){var base=eng.utils.cloneObject(field);var dsObjDef=eng.getDataSourceObjDef(eng.utils.removeAttribute(base,"dataSource"));var dsf;var dsfmt;if(dsObjDef.dsName){var ds=eng.createDataSource(dsObjDef,true,base);dsObjDef.ds=ds;if(ds==null)console.log("Undefined DS:",dsObjDef,field);else{dsf=ds.displayField;dsfmt=ds.displayFormat;ds.canQueueRequests=false}}if(base.displayFormat)dsfmt=base.displayFormat;if(base.multiple===true)base.required=false;if(!base.editorType)if(dsfmt||
base.multiple===true)base.editorType="SelectItem";else if(base.canFilter!=undefined){if(base.canFilter===true)base.editorType="ComboBoxItem";else base.editorType="SelectItem";eng.utils.removeAttribute(base,"canFilter")}else base.editorType="ComboBoxItem";if(!base.valueField)base.valueField="_id";base.displayField=dsf;if(dsfmt)base.formatValue=function(value,baserecord,form,item){var record=item.getSelectedRecord();if(record)if("function"==typeof dsfmt)return dsfmt(value,record);else return eval(dsfmt);
else return value};base.optionDataSource=dsObjDef.dsId;if(!base.editorProperties)base.editorProperties={};if(!base.editorProperties.displayField)base.editorProperties.displayField=dsf;if(!base.editorProperties.addUnknownValues)base.editorProperties.addUnknownValues=false;if(!base.editorProperties.sortField)if(base.editorProperties.sortField===null)delete base.editorProperties.sortField;else base.editorProperties.sortField=dsf;if(base.textMatchStyle)base.editorProperties.textMatchStyle=base.textMatchStyle;
else if(!base.editorProperties.textMatchStyle)base.editorProperties.textMatchStyle="substring";if(base.getFilterCriteria)base.editorProperties.getPickListFilterCriteria=eng.utils.removeAttribute(base,"getFilterCriteria");if(base.showFilter)base.pickListProperties={showFilterEditor:eng.utils.removeAttribute(base,"showFilter")};if(base.selectFields)base.pickListFields=eng.utils.removeAttribute(base,"selectFields");if(base.selectWidth)base.pickListWidth=eng.utils.removeAttribute(base,"selectWidth");
if(base.initialCriteria)base.optionCriteria=eng.utils.removeAttribute(base,"initialCriteria");if(base.dependentSelect){var fname=base.dependentSelect;var pname=undefined;if("object"==typeof fname){fname=base.dependentSelect.dependentField;pname=base.dependentSelect.filterProp}base.changed=function(form,item,value){var ret={};var field=form.getField(fname);field.setValue(null);if(!pname)for(var attr in field.getOptionDataSource().fields){var ds=field.getOptionDataSource().fields[attr].optionDataSource;
if(ds==item.optionDataSource)pname=field.getOptionDataSource().fields[attr].name}ret[pname]=value;field.optionCriteria=ret};base.formatEditorValue=function(value,record,form,item,grid){if(value&&!grid){var field=form.getField(fname);if(field&&!field.optionCriteria){var ret={};if(!pname)for(var attr in field.getOptionDataSource().fields){var ds=field.getOptionDataSource().fields[attr].optionDataSource;if(ds&&ds==item.optionDataSource)pname=attr}ret[pname]=value;field.optionCriteria=ret}}else if(grid){var field=
grid.getField(fname);if(field&&form!=field._lastFilterCriterial){field._lastFilterCriterial=form;var ret={};if(!pname){var dsf=DataSource.get(field.optionDataSource).fields;for(var attr in dsf){var ds=dsf[attr].optionDataSource;if(ds&&ds==grid.getCellField(form,item).optionDataSource)pname=attr}}ret[pname]=value;field.optionCriteria=ret}}return value}}return base};
eng.fieldProcesors["multiSelect"]=function(field){var base=eng.utils.cloneObject(field);base.multiple=true;var dsObjDef=eng.getDataSourceObjDef(eng.utils.removeAttribute(base,"dataSource"));var dsf;var dsfmt;if(dsObjDef.dsName){var ds=eng.createDataSource(dsObjDef,true,base);dsObjDef.ds=ds;if(ds==null)console.log("Undefined DS:",dsObjDef,field);else{dsf=ds.displayField;dsfmt=ds.displayFormat;ds.canQueueRequests=false}}if(base.displayFormat)dsfmt=base.displayFormat;if(!base.editorType)base.editorType=
"MultiComboBoxItem";if(!base.valueField)base.valueField="_id";base.displayField=dsf;if(dsfmt)base.formatValue=function(value,baserecord,form,item){var record=item.getSelectedRecord();if(record)if("function"==typeof dsfmt)return dsfmt(value,record);else return eval(dsfmt);else return value};base.optionDataSource=dsObjDef.dsId;if(!base.comboBoxProperties)base.comboBoxProperties={};if(!base.comboBoxProperties.displayField)base.comboBoxProperties.displayField=dsf;if(!base.comboBoxProperties.addUnknownValues)base.comboBoxProperties.addUnknownValues=
false;if(!base.comboBoxProperties.sortField)if(base.comboBoxProperties.sortField===null)delete base.comboBoxProperties.sortField;else base.comboBoxProperties.sortField=dsf;if(base.textMatchStyle)base.comboBoxProperties.textMatchStyle=base.textMatchStyle;else if(!base.comboBoxProperties.textMatchStyle)base.comboBoxProperties.textMatchStyle="substring";if(base.getFilterCriteria)base.comboBoxProperties.getPickListFilterCriteria=eng.utils.removeAttribute(base,"getFilterCriteria");if(base.showFilter)base.comboBoxProperties.pickListProperties=
{showFilterEditor:eng.utils.removeAttribute(base,"showFilter")};if(base.selectFields)base.comboBoxProperties.pickListFields=eng.utils.removeAttribute(base,"selectFields");if(base.selectWidth)base.comboBoxProperties.pickListWidth=eng.utils.removeAttribute(base,"selectWidth");if(base.initialCriteria)base.optionCriteria=eng.utils.removeAttribute(base,"initialCriteria");return base};
eng.fieldProcesors["grid"]=function(field){var base=eng.utils.cloneObject(field);if(!base.editorType)base.editorType="GridEditorItem";if(!base.width)base.width="100%";if(!base.height)base.height="250";if(!base.startRow)base.startRow=true;if(!base.colSpan)base.colSpan=5;if(base.canReorderRecords===undefined)base.canReorderRecords=true;return base};
eng.fieldProcesors["gridView"]=function(field){var base=eng.utils.cloneObject(field);if(!base.editorType)base.editorType="GridViewItem";if(!base.width)base.width="100%";if(!base.height)base.height="150";if(!base.startRow)base.startRow=true;if(!base.colSpan)base.colSpan=5;return base};
eng.fieldProcesors["gridSelect"]=function(field){var base=eng.utils.cloneObject(field);var dsObjDef=eng.getDataSourceObjDef(eng.utils.removeAttribute(base,"dataSource"));var ds;var dsf;if(dsObjDef.dsName){ds=eng.createDataSource(dsObjDef,true,base);dsObjDef.ds=ds;if(ds==null)console.log("Undefined DS:",dsObjDef,field);else dsf=ds.displayField}if(!base.valueField)base.valueField="_id";base.displayField=dsf;if(base.displayFormat)base.formatValue=function(value,baserecord,form,item){var record=item.getSelectedRecord();
if(record)if("function"==typeof base.displayFormat)return base.displayFormat(value,record);else return eval(base.displayFormat);else return value};base.dsDef=dsObjDef;base.optionDataSource=dsObjDef.dsId;if(!base.editorType)base.editorType="GridSelectItem";if(!base.width)base.width="100%";if(!base.height)base.height="250";if(!base.startRow)base.startRow=true;if(!base.colSpan)base.colSpan=5;return base};
eng.fieldProcesors["listGridSelect"]=function(field){var base=eng.utils.cloneObject(field);var dsObjDef=eng.getDataSourceObjDef(eng.utils.removeAttribute(base,"dataSource"));var ds;var dsf;if(dsObjDef.dsName){ds=eng.createDataSource(dsObjDef,true,base);dsObjDef.ds=ds;if(ds==null)console.log("Undefined DS:",dsObjDef,field);else dsf=ds.displayField}if(!base.valueField)base.valueField="_id";base.displayField=dsf;if(base.displayFormat)base.formatValue=function(value,baserecord,form,item){var record=item.getSelectedRecord();
if(record)if("function"==typeof base.displayFormat)return base.displayFormat(value,record);else return eval(base.displayFormat);else return value};base.dsDef=dsObjDef;base.optionDataSource=dsObjDef.dsId;if(!base.editorType)base.editorType="ListGridSelectItem";if(!base.width)base.width="100%";if(!base.height)base.height="250";if(!base.startRow)base.startRow=true;if(!base.colSpan)base.colSpan=5;return base};
eng.fieldProcesors["time"]=function(field){var base=eng.utils.cloneObject(field);if(!base.type)base.type="time";if(!base.minuteIncrement)base.minuteIncrement=15;if(!base.useTextField)base.useTextField=false;return base};
eng.fieldProcesors["file"]=function(field){var base=eng.utils.cloneObject(field);if(!base.editorType)base.editorType="FileUpload";base.validators=[{type:"custom",condition:function(field,validator,value,p4){if(Array.isArray(value))for(var i=0;i<value.length;i++){var f=value[i];if(f.percent&&f.percent<100)return false}return true},errorMessage:"Carga de archivo en proceso..."}];base.formatCellValue=function(value,record,row,col){console.log("formatCellValue",value);var ret="";if(Array.isArray(value))for(var i=
0;i<value.length;i++){var f=value[i];ret+='<a style="color: #404040;text-decoration: none;" target="_new" href="/fd/'+f.id+"/"+f.name+'">'+f.name;if(f.percent)ret+=" ("+f.percent+"%)";ret+="</a>";if(i<value.length-1)ret+=", "}return ret};return base};
eng.fieldProcesors["html"]=function(field){var base=eng.utils.cloneObject(field);if(!base.editorType)base.editorType="RichTextItem";if(!base.width)base.width="100%";if(!base.height)base.height="200";if(!base.startRow)base.startRow=true;if(!base.colSpan)base.colSpan=5;if(!base.showTitle)base.showTitle=true;if(!base.controlGroups)base.controlGroups=["fontControls","formatControls","styleControls","colorControls","bulletControls"];return base};
eng.fieldProcesors["googleMaps"]=function(field){var base=eng.utils.cloneObject(field);if(!base.editorType)base.editorType="GoogleMapsItem";if(!base.width)base.width="100%";if(!base.height)base.height="300";if(!base.startRow)base.startRow=true;if(!base.colSpan)base.colSpan=5;return base};isc.ClassFactory.defineClass("GridEditorItem","CanvasItem");
isc.GridEditorItem.addProperties({height:"*",width:"*",rowSpan:"*",endRow:true,startRow:true,winEdit:false,shouldSaveValue:true,createCanvas:function(){this.dataSourceName=this.dataSource;this.dataSource=eng.createDataSource(this.dataSource,true,this);var canEdit=this.canEdit!==undefined?this.canEdit:this.form.canEdit!==undefined?this.form.canEdit:true;this.canEdit=true;var totalsLabel=isc.Label.create({padding:5});var toolStrip=null;if(canEdit){this.editButton=isc.ToolStripButton.create({icon:"[SKIN]/actions/edit.png",
prompt:"Edit registro seleccionado",click:function(){if(this.parentElement.parentElement.winEdit){var record=this.parentElement.parentElement.getSelectedRecord();var field=this.parentElement.parentElement.canvasItem;var win=eng.editWindowForm(field.winEdit,record._id,field.dataSourceName);if(win.form!=null)win.form.fromGrid=this.parentElement.parentElement}else{var record=this.parentElement.parentElement.getSelectedRecord();if(record==null)return;this.parentElement.parentElement.startEditing(this.parentElement.parentElement.data.indexOf(record))}}});
var mem=[totalsLabel,isc.LayoutSpacer.create({width:"*"})];if(this.canAdd!==false){this.addButton=isc.ToolStripButton.create({icon:"[SKIN]/actions/add.png",prompt:"Agregar nuevo registro",click:function(){var g=this.parentElement.parentElement;var field=g.canvasItem;if(g.winEdit){var win=eng.editWindowForm(field.winEdit,null,field.dataSourceName);if(win.form!=null)win.form.fromGrid=this.parentElement.parentElement}else g.startEditingNew()}});if(this.addButtonClick!==undefined)this.addButton.click=
this.addButtonClick;mem.push(this.addButton)}mem.push(this.editButton);if(this.canRemove!==false){this.removeButton=isc.ToolStripButton.create({icon:"[SKIN]/actions/remove.png",prompt:"Eliminar registro seleccionado",click:function(){var records=this.parentElement.parentElement.getSelection();if(records==null)return;for(var i=records.length;i--;){var record=records[i];this.parentElement.parentElement.markRecordRemoved(this.parentElement.parentElement.data.indexOf(record))}}});mem.push(this.removeButton)}toolStrip=
isc.ToolStrip.create({width:"100%",height:24,members:mem})}else toolStrip=isc.ToolStrip.create({width:"100%",height:24,members:[totalsLabel,isc.LayoutSpacer.create({width:"*"})]});var _this=this;var grid=isc.ListGrid.create({width:this.width,height:this.height,leaveScrollbarGaps:false,dataSource:this.dataSource,fields:this.fields,autoFetchData:false,alternateRecordStyles:this.alternateRecordStyles?this.alternateRecordStyles:true,warnOnRemoval:true,sortField:this.gridSortField,canEdit:canEdit,winEdit:this.winEdit,
autoSaveEdits:false,gridComponents:["filterEditor","header","body","summaryRow",toolStrip],initialCriteria:this.initialCriteria,showRecordComponents:this.showRecordComponents,showRecordComponentsByCell:this.showRecordComponentsByCell,createRecordComponent:this.createRecordComponent,groupStartOpen:this.groupStartOpen,groupByField:this.groupByField,showGridSummary:this.showGridSummary,wrapCells:this.wrapCells,editEvent:this.editEvent,editByCell:this.editByCell,canReorderFields:this.canReorderFields,
canReorderRecords:this.canReorderRecords,canResizeFields:this.canResizeFields,canSort:this.canSort,canSelect:this.canSelect,baseStyle:this.baseStyle,canRemoveRecords:canEdit&&this.canRemove!==false,headerSpans:this.headerSpans,editByCell:this.editByCell,visibility:this.visibility?this.visibility:"hidden",recordDoubleClick:function(viewer,record,recordNum,field,fieldNum,value,rawValue){if(this.canvasItem.winEdit){var field=this.canvasItem;var win=null;if(record&&record!=null)win=eng.editWindowForm(field.winEdit,
record._id,field.dataSourceName);else win=eng.editWindowForm(field.winEdit,null,field.dataSourceName,viewer.getEditValues(recordNum));if(win.form!=null)win.form.fromGrid=this}else if(this.canEdit)this.startEditing(recordNum)},dataChanged:this.dataChanged?this.dataChanged:function(){this.Super("dataChanged",arguments);var totalRows=this.data.getLength();if(totalRows>0&&this.data.lengthIsKnown())totalsLabel.setContents(totalRows+" Registros");else totalsLabel.setContents(" ")},recordDrop:function(draggedRecords,
targetRecord,targetIndex,sourceWidget){this.Super("recordDrop",arguments);console.log(this,_this);var val=[];for(var x=0;x<grid.data.localData.length;x++)val.push(grid.data.localData[x]._id);_this.form.setValue(_this.name,val);console.log(val)}});if(this.getEditorProperties!==undefined)grid.getEditorProperties=this.getEditorProperties;if(this.cellHeight!==undefined)grid.cellHeight=this.cellHeight;if(this.headerHeight!==undefined)grid.headerHeight=this.headerHeight;if(this.recordDoubleClick!==undefined)grid.recordDoubleClick=
this.recordDoubleClick;if(this.removeRecordClick!==undefined)grid.removeRecordClick=this.removeRecordClick;if(this.listEndEditAction!==undefined)grid.listEndEditAction=this.listEndEditAction;if(this.enterKeyEditAction!==undefined)grid.enterKeyEditAction=this.enterKeyEditAction;grid.form=this.form;grid.canvasItem=this;this.grid=grid;eng.linkFormGrid(this.form,this.grid);if(this.winEdit)grid.canEdit=false;return grid},isEditable:function(){return this.canvas.canEdit},validate:function(){this.grid.endEditing();
for(i=0;i<this.grid.getAllEditRows().length;i++){var earr=this.grid.getAllEditRows();if(this.grid.recordMarkedAsRemoved(earr[i])==true&&this.grid.getRecord(earr[i])==null){this.grid.discardEdits(earr[i]);i--}}var earr=this.grid.getAllEditRows();for(i=0;i<earr.length;i++)if(this.grid.recordMarkedAsRemoved(earr[i])==false&&this.grid.validateRow(earr[i])==false){var err=this.grid.getRowValidationErrors(earr[i]);err.form=this.grid;eng.validates.errors.push(err);return false}return true},showValue:function(displayValue,
dataValue){if(this.canvas==null)return;if((!dataValue||dataValue==null)&&this.grid.getAllEditRows().length>0)return;if(this.grid.invalidate==false&&this.dataValue&&dataValue&&this.dataValue.toString()==dataValue.toString())return;if(dataValue&&dataValue.length>0){this.grid.discardAllEdits(null);this.dataValue=dataValue;try{this.grid.invalidateCache()}catch(err){console.log(err)}if(dataValue!=null){this.grid.invalidate=false;if("string"==typeof dataValue){console.log(dataValue,this);dataValue=dataValue.split(",");
this.form.setValue(this.name,dataValue);this.dataValue=dataValue;console.log(dataValue,this)}this.grid.fetchData({_id:dataValue},function(dsResponse,data,dsRequest){})}}else{this.dataValue=null;this.grid.discardAllEdits(null);this.grid.setData([])}}});isc.ClassFactory.defineClass("GridViewItem","CanvasItem");
isc.GridViewItem.addProperties({height:"*",width:"*",rowSpan:"*",endRow:true,startRow:true,createCanvas:function(){var grid=isc.ListGrid.create({width:this.width,height:this.height,leaveScrollbarGaps:false,fields:this.fields,autoFetchData:false,alternateRecordStyles:this.alternateRecordStyles?this.alternateRecordStyles:true,sortField:this.gridSortField,autoSaveEdits:false,cellHeight:this.cellHeight,autoFitData:"vertical",autoFitMaxRecords:5,initialCriteria:this.initialCriteria,showRecordComponents:this.showRecordComponents,
showRecordComponentsByCell:this.showRecordComponentsByCell,createRecordComponent:this.createRecordComponent,groupStartOpen:this.groupStartOpen,groupByField:this.groupByField,showGridSummary:this.showGridSummary,wrapCells:this.wrapCells,canReorderFields:this.canReorderFields,canResizeFields:this.canResizeFields,canSort:this.canSort,canSelect:this.canSelect,baseStyle:this.baseStyle,headerHeight:this.headerHeight?this.headerHeight:25,headerSpans:this.headerSpans,visibility:this.visibility?this.visibility:
"hidden",data:this.data});if(this.recordDoubleClick!==undefined)grid.recordDoubleClick=this.recordDoubleClick;if(this.removeRecordClick!==undefined)grid.removeRecordClick=this.removeRecordClick;grid.form=this.form;grid.canvasItem=this;this.grid=grid;return grid},isEditable:function(){return false}});isc.ClassFactory.defineClass("FileUpload","CanvasItem");
isc.FileUpload.addProperties({width:"*",height:"*",padding:"*",shouldSaveValue:true,startRow:true,colSpan:5,discardEditsOnHideField:false,filters:{mime_types:[]},createCanvas:function(){console.log("createCanvas");var c=isc.HTMLFlow.create({width:this.width,height:this.height,padding:this.padding,canDragResize:true,showEdges:false,autoDraw:false,canEdit:this.canEdit!==undefined?this.canEdit:this.form.canEdit!==undefined?this.form.canEdit:true});return c},isEditable:function(){return this.canvas.canEdit},
remove:function(id){console.log("remove");var vals=this.canvas.canvasItem.form.getValue(this.canvas.canvasItem.name);var ret=[];for(var i=0;i<vals.length;i++){var f=vals[i];if(f.id!==id)ret.push(f)}this.canvas.canvasItem.form.setValue(this.canvas.canvasItem.name,ret);this.canvas.uploader.removeFile(id)},showValue:function(displayValue,dataValue,p1,p2,p3){console.log("showValue:",displayValue,dataValue);if(this.canvas==null)return;var content="";if(dataValue)if(Array.isArray(dataValue))for(var i=0;i<
dataValue.length;i++){var p=100;if(dataValue[i].percent)p=dataValue[i].percent;content+='        <span><a style="color: #404040;text-decoration: none;" target="_new" href="/fd/'+dataValue[i].id+"/"+encodeURI(dataValue[i].name)+'">'+dataValue[i].name+"</a>";if(p<100)content+=" ("+p+")";if(this.isEditable())content+='<img style="margin-left: 2px; cursor: pointer; vertical-align: middle;" onClick="'+this.ID+".remove('"+dataValue[i].id+'\');" src="/platform/isomorphic/skins/Tahoe/images/actions/close.png"/>';
if(i<dataValue.length-1)content+=",";content+="        </span>"}if(this.isEditable())content='<button onclick="'+this.ID+'_button.click()">Cargar Archivo</button>'+content;content='<div style="height:18px;">'+content+"</div>";this.canvas.setContents(content);if(this.isEditable()&&!this.canvas.uploader)this.initUploader(this.canvas)},initUploader:function(canvas){console.log("initUploader:",this.ID);var div=document.createElement("div");div.innerHTML='<div id="'+this.ID+'_container" style="display:none">\n'+
'    <button id="'+this.ID+'_button">Elegir Archivos</button> \n'+"</div>\n";var old=document.getElementById(this.ID+"_container");if(old)old.remove();document.body.appendChild(div);var uploader=new plupload.Uploader({runtimes:"html5,flash,silverlight,html4",browse_button:this.ID+"_button",container:this.ID+"_container",url:"/platform/jsp/plupload.jsp",flash_swf_url:"/platform/plupload/js/Moxie.swf",silverlight_xap_url:"/platform/pluploadjs/Moxie.xap",chunk_size:"4mb",unique_names:true,max_file_size:this.maxFileSize,
filters:this.filters,init:{PostInit:function(){},FilesAdded:function(up,files){var vals;vals=this.canvas.canvasItem.form.getValue(this.canvas.canvasItem.name);if(!Array.isArray(vals))vals=[];else vals=eng.utils.cloneObject(vals);for(var i=0;i<files.length;i++){var f=files[i];if(this.canvas.canvasItem.grid)f.grid={rowNum:this.canvas.canvasItem.rowNum,colNum:this.canvas.canvasItem.colNum};vals.push({id:f.id,name:f.name,lastModifiedDate:f.lastModifiedDate,size:f.size,target_name:f.target_name,type:f.type,
percent:f.percent})}this.canvas.canvasItem.form.setValue(this.canvas.canvasItem.name,vals);uploader.start()},FileUploaded:function(up,file,info){},ChunkUploaded:function(up,file,info){},UploadComplete:function(up,files){if(this.onUploadComplete)onUploadComplete(up,files)},UploadProgress:function(up,file){var vals;vals=this.canvas.canvasItem.form.getValue(this.canvas.canvasItem.name);if(vals){for(var i=0;i<vals.length;i++){var f=vals[i];if(f.id===file.id)if(file.percent<100)f.percent=file.percent;
else delete f.percent}this.canvas.canvasItem.form.setValue(this.canvas.canvasItem.name,vals)}},Error:function(up,err){isc.say(err.message)}}});canvas.uploader=uploader;uploader.canvas=canvas;uploader.init()}});isc.ClassFactory.defineClass("GridSelectItem","CanvasItem");
isc.GridSelectItem.addProperties({height:"*",width:"*",rowSpan:"*",endRow:true,startRow:true,shouldSaveValue:true,createCanvas:function(){this.dataSource=eng.createDataSource(this.dsDef,true,this);var grid1=isc.ListGrid.create({fields:eng.mergeAndArray(eng.getDataSource(this.dsDef.dsName).getDataSourceScript().fields,this.fieldsSelect),width:"30%",height:this.height,alternateRecordStyles:true,canDragRecordsOut:true,canAcceptDroppedRecords:true,dragDataAction:"move",showAllRecords:true,initialCriteria:this.initialCriteria,
autoFetchData:false,autoDraw:false,data:eng.getDataSource(this.dsDef.dsName).fetch({data:this.initialCriteria}).data,recordDrop:function(draggedRecords,targetRecord,targetIndex,sourceWidget){this.Super("recordDrop",arguments);_this.storeData()}});var grid2=isc.ListGrid.create({fields:eng.mergeAndArray(eng.getDataSource(this.dsDef.dsName).getDataSourceScript().fields,this.fields),width:"60%",height:this.height,alternateRecordStyles:true,showAllRecords:true,emptyMessage:"No hay elementos seleccionados...",
canDragRecordsOut:true,canAcceptDroppedRecords:true,canReorderRecords:true,dragDataAction:"move",autoFetchData:false,autoDraw:false,recordDrop:function(draggedRecords,targetRecord,targetIndex,sourceWidget){this.Super("recordDrop",arguments);_this.storeData()}});var _this=this;_this.storeData=function(){var val=[];for(var x=0;x<grid2.data.length;x++)val.push(grid2.data[x]._id);_this.form.setValue(_this.name,val);console.log(val)};var c=isc.HStack.create({membersMargin:10,width:this.width,height:this.height,
autoDraw:false,members:[grid1,isc.VStack.create({width:"32",height:74,layoutAlign:"center",membersMargin:10,autoDraw:false,members:[isc.Img.create({src:"/platform/isomorphic/skins/Tahoe/images/DynamicForm/unstacked_spinner_plus.png",autoDraw:false,height:"25px",click:function(){grid2.transferSelectedData(grid1);_this.dataValue=grid2.data;_this.storeData()}}),isc.Img.create({src:"/platform/isomorphic/skins/Tahoe/images/DynamicForm/unstacked_spinner_minus.png",autoDraw:false,height:"25px",click:function(){grid1.transferSelectedData(grid2);
_this.dataValue=grid2.data;var val=[];for(var x=0;x<grid2.data.length;x++)val.push(grid2.data[x]._id);_this.storeData()}})]}),grid2]});this.gridSelect=grid1;this.grid=grid2;return c},showValue:function(displayValue,dataValue){if(this.canvas==null)return;if(this.dataValue===dataValue)return;this.dataValue=dataValue;if(this.grid.data.length>0)this.gridSelect.setData(eng.getDataSource(this.dsDef.dsName).fetch({data:this.initialCriteria}).data);if(dataValue){this.grid.setData([]);this.gridSelect.deselectAllRecords();
for(var i=0;i<dataValue.length;i++)for(var j=0;j<this.gridSelect.data.length;j++)if(this.gridSelect.data[j]._id===dataValue[i])this.gridSelect.selectRecord(j);this.grid.transferSelectedData(this.gridSelect);this.grid.deselectAllRecords()}}});isc.ClassFactory.defineClass("ListGridSelectItem","CanvasItem");
isc.ListGridSelectItem.addProperties({height:"*",width:"*",rowSpan:"*",endRow:true,startRow:true,shouldSaveValue:true,createCanvas:function(){this.dataSource=eng.createDataSource(this.dsDef,true,this);var grid=isc.ListGrid.create({name:this.name,width:this.width,isShowing:false,height:this.height,alternateRecordStyles:true,data:eng.getDataSource(this.dsDef.dsName).fetch({data:this.initialCriteria}).data,fields:this.fields,wrapCells:true,fixedRecordHeights:false,selectionAppearance:"checkbox",selectionType:this.multiple?
"simple":"single",autoFetchData:false,dataSource:this.dataSource,selectionChanged:function(record,state){if(this.isShowing)return;if(this.selectionType=="single")this.parentElement.setValue(this.name,state?record._id:null);else{var values=this.parentElement.getValue(this.name);if(!(values instanceof Array))values=[];if(state)values.push(record._id);else values.remove(record._id);this.parentElement.setValue(this.name,values)}}});this.grid=grid;return grid},showValue:function(displayValue,dataValue){if(this.canvas==
null)return;if(this.dataValue===dataValue)return;this.dataValue=dataValue;this.canvas.isShowing=true;if(dataValue)if(dataValue instanceof Array)for(var i=0;i<dataValue.length;i++)for(var j=0;j<this.grid.data.length;j++){if(this.grid.data[j]._id===dataValue[i])this.grid.selectRecord(j)}else for(var j=0;j<this.grid.data.length;j++)if(this.grid.data[j]._id===dataValue){this.grid.selectRecord(j);break}this.canvas.isShowing=false}});isc.ClassFactory.defineClass("GoogleMapsItem",isc.CanvasItem);
isc.GoogleMapsItem.addProperties({shouldSaveValue:true,createCanvas:function(){this.gmapsID=this.ID+"_map";this.dataSource=eng.createDataSource(this.dsDef,true,this);var c=isc.VLayout.create({members:[isc.HTMLFlow.create({width:"100%",height:"*",contents:'<input id="pac-input_'+this.ID+'" class="searchBoxGoogleMaps" style="width:50%;" type="text" placeholder="Buscar calle">'}),isc.HTMLFlow.create({width:"100%",height:"*",contents:'<div class="boxedGoogleMaps" style="width:'+this.width+"px;height:"+
this.height+'px;">\n                                <div id="'+this.gmapsID+'" style="width:99%;height:99%;"></div>\n                            </div>'}),isc.HTMLFlow.create({width:"100%",height:"*",contents:'<div><input onclick="deleteMarkers();" type=button value="Borrar marcas"></div>'})]});document.write('<script type="text/javascript" async defer>\n');document.write("var map,markers=[];");document.write("function initMap_"+this.ID+'(){var townDown={lat:19.432692,lng:-99.133434};map=new google.maps.Map(document.getElementById("'+
this.gmapsID+'"),{zoom:12,center:townDown,mapTypeId:google.maps.MapTypeId.ROADMAP,styles:[{featureType:"poi",stylers:[{visibility:"off"}]},{featureType:"transit.station",stylers:[{visibility:"off"}]}],disableDoubleClickZoom:true,streetViewControl:false});map.addListener("dblclick",function(event){addMarker(event.latLng);'+this.ID+".setCenter(this)});");document.write('var input=document.getElementById("pac-input_'+this.ID+'");var searchBox=new google.maps.places.SearchBox(input);map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);');
document.write('map.addListener("bounds_changed",function(){searchBox.setBounds(map.getBounds());});');document.write('searchBox.addListener("places_changed",function(){var places=searchBox.getPlaces();if(places.length==0){return;}');document.write("var bounds=new google.maps.LatLngBounds();");document.write("places.forEach(function(place){");document.write("var icon={url:place.icon,size:new google.maps.Size(71,71),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(17,34),scaledSize:new google.maps.Size(25,25)};");
document.write("if(place.geometry.viewport){bounds.union(place.geometry.viewport);}else{bounds.extend(place.geometry.location);}});");document.write("map.fitBounds(bounds);});");document.write("}\n");document.write("function addMarker(location){var marker=new google.maps.Marker({position:location,map: map});markers.push(marker);map.setCenter(location);}");document.write("function deleteMarkers(){for(var i=0;i<markers.length;i++){markers[i].setMap(null);}markers=[];}");document.write("\x3c/script>");
if(this.mapping===1)document.write('<script src="https://maps.googleapis.com/maps/api/js?key='+this.apiKey+"&libraries=places&callback=initMap_"+this.ID+'" async defer>\x3c/script>');return c},setCenter:function(position){this.form.setValue(this.name,'{"lat":'+position.center.lat()+',"lng":'+position.center.lng()+"}")},showValue:function(displayValue,dataValue,form,self){if(self)if(self.getValue()&&self.getValue()!==null){var pos=JSON.parse(self.getValue());var marker=new google.maps.Marker({position:pos,
map:map});markers.push(marker);map.setCenter(pos)}}});